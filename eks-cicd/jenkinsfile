pipeline {
  agent any

  environment {
    VAULT_ADDR = 'http://0.0.0.0:8200'
  }

  stages {
    stage('Fetch AWS Credentials from Vault') {
      steps {
        script {
          def creds = sh(script: "vault kv get -format=json aws/terraform-project", returnStdout: true)
          def parsed = readJSON text: creds
          env.AWS_ACCESS_KEY_ID = parsed.data.data.aws_access_key_id
          env.AWS_SECRET_ACCESS_KEY = parsed.data.data.aws_secret_access_key
        }
      }
    }

    stage('Terraform Init') {
      steps {
        sh 'terraform init'
      }
    }

    stage('Terraform Plan') {
      steps {
        sh 'terraform plan'
      }
    }

    stage('Terraform Apply') {
      steps {
        input "Apply infrastructure?"
        sh 'terraform apply -auto-approve'
      }
    }

    stage('Update Kubeconfig') {
      steps {
        sh 'aws eks update-kubeconfig --region us-east-1 --name EKS-CLUSTER321'
      }
    }
  }
}
